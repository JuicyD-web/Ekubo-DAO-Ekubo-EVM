name: Test & Coverage

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
      
      - name: Install dependencies
        run: forge install
      
      - name: Run tests
        run: forge test -vvv
      
      - name: Check coverage (80% threshold)
        run: |
          forge coverage --report summary | tee coverage.txt
          COVERAGE=$(grep "Total" coverage.txt | awk '{print $2}' | sed 's/%//')
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage $COVERAGE% below 80% threshold"
            exit 1
          fi
      
      - name: Check contract sizes (24kb limit)
        run: |
          forge build --sizes | tee sizes.txt
          if awk '$3 > 24 {exit 1}' sizes.txt; then
            echo "All contracts within size limit"
          else
            echo "Some contracts exceed 24kb"
            exit 1
          fi